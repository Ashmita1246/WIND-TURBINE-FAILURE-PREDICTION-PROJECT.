import streamlit as st
import joblib
import pandas as pd
import base64
from io import BytesIO

# Set page configuration for better appearance
st.set_page_config(
    page_title="Wind Turbine Failure Prediction",
    page_icon="ğŸŒªï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Initialize session state for login
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
if 'username' not in st.session_state:
    st.session_state.username = ""
if 'prediction_data' not in st.session_state:
    st.session_state.prediction_data = None

# Load the saved model
model = joblib.load('wind_turbine_model.pkl')

# Login function
def login():
    st.title("ğŸ” Login to Wind Turbine Prediction System")

    username = st.text_input("Username")
    password = st.text_input("Password", type="password")

    if st.button("Login"):
        # Simple authentication (in production, use proper authentication)
        if username and password:  # Basic check
            st.session_state.logged_in = True
            st.session_state.username = username
            st.success("Login successful!")
            st.rerun()
        else:
            st.error("Please enter valid credentials")

# Main app function
def main_app():
    # App title and introduction
    st.title(f"ğŸŒªï¸ Wind Turbine Failure Prediction - Welcome {st.session_state.username}")
    st.markdown("""
    ### Welcome to the Wind Turbine Failure Prediction App
    This app uses a machine learning model to predict potential failures in wind turbines based on operational parameters.
    Enter the turbine data in the sidebar and click **Predict Failure** to get results.
    """)

    # Sidebar for inputs
    st.sidebar.header("ğŸ”§ Enter Turbine Data")
    st.sidebar.markdown("Adjust the sliders below to input the turbine parameters:")

    wind_speed = st.sidebar.slider("Wind Speed (m/s)", 0.0, 30.0, 10.0)
    temperature = st.sidebar.slider("Temperature (Â°C)", -10.0, 40.0, 15.0)
    humidity = st.sidebar.slider("Humidity (%)", 0.0, 100.0, 50.0)
    vibration = st.sidebar.slider("Vibration", 0.0, 5.0, 0.5)
    rotor_speed = st.sidebar.slider("Rotor Speed (RPM)", 1000.0, 2000.0, 1500.0)
    power_output = st.sidebar.slider("Power Output (kW)", 0.0, 5000.0, 2000.0)
    turbine_age = st.sidebar.slider("Turbine Age (years)", 0.0, 25.0, 10.0)

    # Logout button
    if st.sidebar.button("Logout"):
        st.session_state.logged_in = False
        st.session_state.username = ""
        st.session_state.prediction_data = None
        st.rerun()

    # Main area for prediction
    st.header("ğŸ” Prediction Results")
    if st.button("Predict Failure", type="primary"):
        # Create input DataFrame
        input_data = pd.DataFrame({
            'wind_speed': [wind_speed],
            'temperature': [temperature],
            'humidity': [humidity],
            'vibration': [vibration],
            'rotor_speed': [rotor_speed],
            'power_output': [power_output],
            'turbine_age': [turbine_age]
        })

        # Make prediction
        prediction = model.predict(input_data)[0]
        probability = model.predict_proba(input_data)[0][1]  # Probability of failure

        # Store prediction data for PDF generation
        st.session_state.prediction_data = {
            'input_data': input_data,
            'prediction': prediction,
            'probability': probability,
            'username': st.session_state.username
        }


        # Display result with enhanced formatting
        if prediction == 1:
            st.error("âš ï¸ **Prediction: Failure Likely**")
            st.metric("Failure Probability", f"{probability:.2%}")
            st.markdown("**Recommendation:** Inspect the turbine for potential issues.")
        else:
            st.success("âœ… **Prediction: No Failure**")
            st.metric("Failure Probability", f"{probability:.2%}")
            st.markdown("**Status:** Turbine appears to be operating normally.")

    # PDF Report Generation
    if st.session_state.prediction_data:
        st.header("ğŸ“„ Generate Report")

        if st.button("Generate Report"):
            # Create PDF content
            pdf_content = f"""
Wind Turbine Failure Prediction Report
=====================================

Generated by: {st.session_state.prediction_data['username']}
Date: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}

Turbine Parameters:
------------------
Wind Speed: {st.session_state.prediction_data['input_data']['wind_speed'].iloc[0]:.2f} m/s
Temperature: {st.session_state.prediction_data['input_data']['temperature'].iloc[0]:.2f} Â°C
Humidity: {st.session_state.prediction_data['input_data']['humidity'].iloc[0]:.2f} %
Vibration: {st.session_state.prediction_data['input_data']['vibration'].iloc[0]:.2f}
Rotor Speed: {st.session_state.prediction_data['input_data']['rotor_speed'].iloc[0]:.2f} RPM
Power Output: {st.session_state.prediction_data['input_data']['power_output'].iloc[0]:.2f} kW
Turbine Age: {st.session_state.prediction_data['input_data']['turbine_age'].iloc[0]:.2f} years

Prediction Results:
------------------
Prediction: {'Failure Likely' if st.session_state.prediction_data['prediction'] == 1 else 'No Failure'}
Failure Probability: {st.session_state.prediction_data['probability']:.2%}

Recommendation:
-------------
{'Inspect the turbine for potential issues.' if st.session_state.prediction_data['prediction'] == 1 else 'Turbine appears to be operating normally.'}

Generated by Wind Turbine Prediction System
Built with Streamlit | Model: Random Forest Classifier
"""

            # Create download link
            b64 = base64.b64encode(pdf_content.encode()).decode()
            href = f'<a href="data:text/plain;base64,{b64}" download="wind_turbine_report.txt">Download Report as TXT</a>'
            st.markdown(href, unsafe_allow_html=True)

    # Footer
    st.markdown("---")
    st.markdown("Built with Streamlit | Model: Wind Turbine Predictor")

# Main logic
if not st.session_state.logged_in:
    login()
else:
    main_app()